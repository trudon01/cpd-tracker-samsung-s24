name: Build Samsung S24 APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“± Checkout Samsung S24 CPD Tracker
      uses: actions/checkout@v4
      
    - name: ðŸ Setup Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: â˜• Setup Java JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: ðŸ“¦ Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: ðŸ“¦ Cache buildozer global directory
      uses: actions/cache@v3
      with:
        path: .buildozer_global
        key: ${{ runner.os }}-buildozer-global-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          ${{ runner.os }}-buildozer-global-
          
    - name: ðŸ“¦ Cache buildozer directory
      uses: actions/cache@v3
      with:
        path: .buildozer
        key: ${{ runner.os }}-buildozer-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          ${{ runner.os }}-buildozer-
          
    - name: ðŸ”§ Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git zip unzip openjdk-17-jdk python3-pip autoconf libtool pkg-config zlib1g-dev libncurses5-dev libncursesw5-dev libtinfo5 cmake libffi-dev libssl-dev
        sudo apt-get install -y build-essential libltdl-dev libffi-dev libssl-dev python3-dev
        
    - name: ðŸ”§ Install Tesseract OCR for Samsung S24
      run: |
        sudo apt-get install -y tesseract-ocr tesseract-ocr-eng
        echo "Tesseract installed for Samsung S24 OCR functionality"
        
    - name: ðŸ Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install buildozer cython==3.0.10
        pip install kivy kivymd plyer
        pip install pytesseract pillow
        pip install google-api-python-client google-auth google-auth-oauthlib google-auth-httplib2
        
    - name: ðŸ› ï¸ Setup buildozer for Samsung S24
      run: |
        # Create buildozer global cache directory
        mkdir -p .buildozer_global
        export BUILDOZER_GLOBAL_PATH=$(pwd)/.buildozer_global
        
        # Verify buildozer.spec is Samsung S24 optimized
        echo "Building APK optimized for Samsung S24 (1080x2340, ARM64-v8a, armeabi-v7a)"
        cat buildozer.spec | grep -E "(archs|api|resolution)"
        
    - name: ðŸ—ï¸ Build Samsung S24 APK with OCR
      run: |
        export BUILDOZER_GLOBAL_PATH=$(pwd)/.buildozer_global
        echo "ðŸš€ Starting Samsung S24 APK build with OCR functionality..."
        echo "ðŸ“± Target: Samsung S24, S24+, S24 Ultra"
        echo "ðŸ” Features: OCR, Camera, Google Drive, CPD Tracking"
        
        # Build the APK
        buildozer android debug
        
        # Verify APK was created
        if [ -f bin/*.apk ]; then
          echo "âœ… Samsung S24 APK build successful!"
          ls -la bin/
        else
          echo "âŒ APK build failed"
          exit 1
        fi
        
    - name: ðŸ“± Rename APK for Samsung S24
      run: |
        cd bin
        # Find the generated APK and rename it
        APK_FILE=$(ls *.apk | head -n 1)
        if [ ! -z "$APK_FILE" ]; then
          NEW_NAME="CPD_Tracker_Samsung_S24_v1.0_$(date +%Y%m%d_%H%M%S).apk"
          mv "$APK_FILE" "$NEW_NAME"
          echo "ðŸ“± APK renamed to: $NEW_NAME"
          echo "APK_NAME=$NEW_NAME" >> $GITHUB_ENV
        fi
        
    - name: ðŸ“Š APK Information
      run: |
        cd bin
        APK_FILE=$(ls *.apk | head -n 1)
        if [ ! -z "$APK_FILE" ]; then
          echo "ðŸ“± Samsung S24 APK Details:"
          echo "ðŸ“ File: $APK_FILE"
          echo "ðŸ“ Size: $(du -h "$APK_FILE" | cut -f1)"
          echo "ðŸ—“ï¸ Built: $(date)"
          echo ""
          echo "ðŸŽ¯ Samsung S24 Optimizations:"
          echo "  âœ… Resolution: 1080x2340"
          echo "  âœ… Architecture: ARM64-v8a, armeabi-v7a"
          echo "  âœ… Android API: 21-31"
          echo "  âœ… OCR: Tesseract engine included"
          echo "  âœ… Permissions: Camera, Storage, Internet"
          echo ""
          echo "ðŸ“‹ App Features:"
          echo "  ðŸ“¸ Samsung Camera Integration"
          echo "  ðŸ” OCR Text Recognition"
          echo "  ðŸ“Š CPD Points Tracking"
          echo "  â˜ï¸ Google Drive Sync"
          echo "  ðŸŽ¨ Material Design UI"
        fi
        
    - name: ðŸŽ‰ Upload Samsung S24 APK
      uses: actions/upload-artifact@v4
      with:
        name: CPD-Tracker-Samsung-S24-APK
        path: bin/*.apk
        retention-days: 30
        
    - name: ðŸ“¦ Create Release Package
      run: |
        mkdir -p release_package
        cp bin/*.apk release_package/
        cp buildozer.spec release_package/
        cp requirements.txt release_package/
        
        # Create installation guide
        cat > release_package/SAMSUNG_S24_INSTALL.md << 'EOF'
        # ðŸ“± Samsung S24 Installation Guide
        
        ## Quick Install
        1. **Download APK** to your Samsung S24
        2. **Enable Unknown Sources**: Settings â†’ Apps â†’ Special access â†’ Install unknown apps
        3. **Install APK**: Tap the APK file and select Install
        4. **Grant Permissions**: Allow camera and storage access
        5. **Launch**: Find "CPD Tracker" in your app drawer
        
        ## Features
        - ðŸ“¸ **Samsung S24 Camera**: Optimized for 1080x2340 resolution
        - ðŸ” **OCR Text Recognition**: Extract text from certificates
        - ðŸ“Š **CPD Points Tracking**: Automatic calculation
        - â˜ï¸ **Google Drive Sync**: Cloud backup
        - ðŸŽ¨ **Material Design**: Samsung One UI compatible
        
        ## System Requirements
        - Samsung S24, S24+, or S24 Ultra
        - Android 5.0+ (API 21+)
        - 100MB storage space
        - Camera and internet permissions
        EOF
        
        # Create build info
        cat > release_package/BUILD_INFO.txt << EOF
        CPD Tracker - Samsung S24 Build Information
        ==========================================
        
        Build Date: $(date)
        Target Device: Samsung S24 series
        Android API: 21-31
        Architecture: ARM64-v8a, armeabi-v7a
        Resolution: 1080x2340 optimized
        
        Features Included:
        âœ… OCR Text Recognition (Tesseract)
        âœ… Samsung Camera Integration
        âœ… CPD Points Tracking
        âœ… Google Drive Synchronization
        âœ… Material Design UI
        âœ… Database with Backup
        âœ… CSV Export Functionality
        
        Build Environment:
        - Python 3.9
        - Kivy 2.3.1
        - Buildozer (latest)
        - Ubuntu 22.04 LTS
        - OpenJDK 17
        EOF
        
    - name: ðŸ“¦ Upload Release Package
      uses: actions/upload-artifact@v4
      with:
        name: CPD-Tracker-Samsung-S24-Complete-Package
        path: release_package/
        retention-days: 90
